<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FODMAP LOGMAP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
          --color-primary: #2d61a0;
          --color-primary-dark: #224978; /* Darker shade for hover */
          --color-secondary: #283b6c;
          --color-accent: #8bb744;
          --color-accent-dark: #6a8e32; /* Darker shade for hover */
          --color-error: #dc2626;
          --color-error-dark: #b91c1c;
          --color-warning: #f59e0b;
          
          --color-text-base: #283b6c; /* Replaces text-slate-800 */
          --color-text-muted: #475569; /* Unchanged text-slate-600 */
          --color-text-subtle: #64748b; /* Unchanged text-slate-500 */
        }

        body {
            font-family: 'Inter', sans-serif;
            /* Fallback padding-top, JS will correct this */
            padding-top: 100px; 
            overscroll-behavior-x: none; /* Prevent browser back/forward swipe */
            color: var(--color-text-base); /* Set base text color */
        }
        .nav-item.active {
            border-bottom-color: var(--color-primary); 
            color: var(--color-primary); 
            font-weight: 600;
        }
        .nav-item {
            border-bottom: 2px solid transparent;
            padding-top: 0.5rem; 
            padding-bottom: 0.5rem; 
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .gemini-modal-content, .ai-results-content { white-space: pre-wrap; }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--color-primary); 
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .log-item-body, .progress-item-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out, padding 0.3s ease-in-out;
            padding: 0 1rem;
        }
        .log-item.expanded .log-item-body, .progress-item.expanded .progress-item-body {
            max-height: 500px; 
            padding: 0.5rem 1rem 0.5rem 1rem; 
        }
        .log-item.expanded .log-item-header .expand-icon, .progress-item.expanded .progress-item-header .expand-icon {
            transform: rotate(90deg);
        }
        .profile-checkbox:checked + label {
            background-color: #eaf0f7; /* Lighter primary */
            border-color: var(--color-primary); 
            color: var(--color-primary-dark); 
        }
        #side-menu-modal { transition: transform 0.3s ease-in-out; }
        #side-menu-modal.hidden { transform: translateX(-100%); }
        #side-menu-overlay { transition: opacity 0.3s ease-in-out; }
        #side-menu-overlay.hidden { opacity: 0; pointer-events: none; }

        /* Compact Info Modal Styles */
        #info-modal-content h2 { font-size: 1.25rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.25rem; color: var(--color-secondary); }
        #info-modal-content h3 { font-size: 1.1rem; font-weight: 600; margin-top: 0.75rem; margin-bottom: 0.25rem; color: var(--color-primary); }
        #info-modal-content p { color: var(--color-text-muted); line-height: 1.5; margin-bottom: 0.25rem; }
        #info-modal-content ul { margin-top: 0.25rem; }
        #info-modal-content .fodmap-group-card { background-color: #f8fafc; border-left-width: 4px; padding: 0.75rem; border-radius: 0.5rem; margin-top: 0.5rem; }
        .progress-item-body p {
            font-size: 0.875rem; /* text-sm */
            line-height: 1.25rem; /* text-sm */
            color: #475569; /* text-slate-600 */
            border-bottom-width: 1px; /* border-b */
            border-color: #e2e8f0; /* border-slate-200 */
            padding-top: 0.375rem; /* py-1.5 */
            padding-bottom: 0.375rem; /* py-1.5 */
         }
         .progress-item-body p:last-child {
            border-bottom-width: 0px; /* border-b-0 */
         }
        #info-modal-content .info-note { background-color: #eaf0f7; border-color: #b9cbe0; margin-top: 1rem; padding: 0.75rem; }
        #info-modal-content .info-note h3 { color: var(--color-secondary); }
        main section > div { margin-bottom: 1rem; }
        #log-entries { gap: 0.75rem; }
        .log-item-header, .progress-item-header { padding: 0.75rem; }

        /* New Utility Classes */
        .text-primary { color: var(--color-primary); }
        .text-secondary { color: var(--color-secondary); }
        .text-accent { color: var(--color-accent); }
        .text-error { color: var(--color-error); }
        .text-warning { color: var(--color-warning); }
        .text-muted { color: var(--color-text-muted); }
        .text-subtle { color: var(--color-text-subtle); }

        .bg-primary { background-color: var(--color-primary); }
        .hover\:bg-primary-dark:hover { background-color: var(--color-primary-dark); }
        
        .bg-accent { background-color: var(--color-accent); }
        .hover\:bg-accent-dark:hover { background-color: var(--color-accent-dark); }
        
        .bg-error { background-color: var(--color-error); }
        .hover\:bg-error-dark:hover { background-color: var(--color-error-dark); }

        .border-primary { border-color: var(--color-primary); }
        .focus\:ring-primary:focus { box-shadow: 0 0 0 2px var(--color-primary); } /* Replaced focus:ring-blue-700 */
        .focus\:border-primary:focus { border-color: var(--color-primary); }

        .hover\:text-primary:hover { color: var(--color-primary); }
        .hover\:text-error-dark:hover { color: var(--color-error-dark); }

        /* FODMAP Group cards in Info Modal */
        #info-modal-content .border-l-blue-400 { border-color: #60a5fa; }
        #info-modal-content .text-blue-700 { color: #1d4ed8; }
        #info-modal-content .border-l-yellow-400 { border-color: #facc15; }
        #info-modal-content .text-yellow-700 { color: #a16207; }
        #info-modal-content .border-l-orange-400 { border-color: #fb923c; }
        #info-modal-content .text-orange-700 { color: #c2410c; }
        #info-modal-content .border-l-purple-400 { border-color: #c084fc; }
        #info-modal-content .text-purple-700 { color: #7e22ce; }
        #info-modal-content .border-l-teal-400 { border-color: #2dd4bf; }
        #info-modal-content .text-teal-700 { color: #0f766e; }
        #info-modal-content .border-l-green-400 { border-color: #4ade80; }
        #info-modal-content .text-green-700 { color: #15803d; }
        #info-modal-content .border-l-indigo-400 { border-color: #818cf8; }
        #info-modal-content .text-indigo-700 { color: #4338ca; }

        /* Styles for Severity Button Group */
        .severity-btn-group {
            display: flex;
            border-radius: 0.5rem; /* rounded-lg */
            overflow: hidden;
            border: 1px solid #cbd5e1; /* border-slate-300 */
        }
        .severity-btn {
            flex: 1;
            padding: 0.5rem 0.25rem; /* py-2 px-1 */
            font-size: 0.875rem; /* text-sm */
            font-weight: 500; /* font-medium */
            text-align: center;
            background-color: #f1f5f9; /* bg-slate-100 */
            color: var(--color-text-muted);
            border-right: 1px solid #cbd5e1;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
            -webkit-tap-highlight-color: transparent; /* Disable tap flash on mobile */
        }
        .severity-btn:last-child {
            border-right: none;
        }
        .severity-btn:hover {
            background-color: #e2e8f0; /* bg-slate-200 */
        }
        .severity-btn.selected {
            background-color: var(--color-primary);
            color: white;
            border-color: var(--color-primary-dark);
        }
    </style>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#2d61a0">
</head>
<body class="bg-slate-50">

    <div id="app" class="max-w-7xl mx-auto p-2 sm:p-4">
        <header class="fixed top-0 left-0 right-0 z-20 bg-slate-50/90 backdrop-blur-sm px-2 sm:px-4 py-2 flex items-center justify-between border-b border-slate-200">
             <button id="hamburger-btn" class="text-muted hover:text-primary text-2xl w-10 h-10 flex items-center justify-center rounded-lg hover:bg-slate-100">
                <i class="fas fa-bars"></i>
            </button>
             <div class="flex flex-col items-center">
                 <img src="fmlm_logo_h.png" alt="FODMAP LOGMAP Logo" class="h-7 sm:h-8">
             </div>
             <div class="w-10"></div> 
        </header>

        <nav id="main-nav" class="fixed left-0 right-0 z-10 flex justify-center border-b border-slate-200 bg-white rounded-b-lg shadow-sm max-w-3xl mx-auto">
            <button data-page="home" class="nav-item flex-1 text-center px-2 sm:px-4 text-muted transition-colors duration-300 ease-in-out hover:bg-slate-100 rounded-bl-lg text-xs sm:text-base">
                <i class="fas fa-home-alt sm:mr-2"></i><span class="hidden sm:inline">Home</span>
            </button>
            <button data-page="food-info" class="nav-item flex-1 text-center px-2 sm:px-4 text-muted transition-colors duration-300 ease-in-out hover:bg-slate-100 text-xs sm:text-base">
                <i class="fas fa-brain sm:mr-2"></i><span class="hidden sm:inline">AI Assistant</span>
            </button>
            <button data-page="reintroduction-log" class="nav-item flex-1 text-center px-2 sm:px-4 text-muted transition-colors duration-300 ease-in-out hover:bg-slate-100 text-xs sm:text-base">
                <i class="fas fa-clipboard-list sm:mr-2"></i><span class="hidden sm:inline">Reintro Log</span>
            </button>
            <button data-page="profile" class="nav-item flex-1 text-center px-2 sm:px-4 text-muted transition-colors duration-300 ease-in-out hover:bg-slate-100 rounded-br-lg text-xs sm:text-base">
                <i class="fas fa-user-cog sm:mr-2"></i><span class="hidden sm:inline">Profile</span>
            </button>
        </nav>

        <main id="content"> 
            <section id="home" class="page hidden max-w-3xl mx-auto">
                <div class="bg-white p-4 sm:p-6 rounded-xl shadow-md">
                    <h2 class="text-xl sm:text-2xl font-semibold mb-3 text-secondary">📈 Reintroduction Progress</h2>
                    <div id="progress-summary" class="space-y-2"> 
                    </div>
                </div>
                 <div class="bg-white p-4 sm:p-6 rounded-xl shadow-md">
                    <h2 class="text-xl sm:text-2xl font-semibold mb-3 text-secondary flex items-center">
                        <i class="fas fa-magic-sparkles text-warning mr-2"></i> 💡 AI Insights
                    </h2>
                    <div class="space-y-3"> 
                        <button id="summarize-journey-btn" class="w-full bg-primary text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-primary-dark transition-colors duration-300 shadow flex items-center justify-center gap-2"> 
                            ✨ Summarize My Journey
                        </button>
                         <p class="text-xs text-slate-400 text-center">Get an AI-powered summary of your reintroduction log to spot potential patterns.</p>
                    </div>
                </div>
            </section>

            <section id="food-info" class="page hidden max-w-3xl mx-auto">
                <div class="bg-white p-4 sm:p-6 rounded-xl shadow-md">
                    <h2 class="text-xl sm:text-2xl font-semibold mb-3 text-secondary flex items-center"><i class="fas fa-brain text-accent mr-2"></i>AI Food Assistant</h2>
                     <p class="text-subtle mb-3 text-sm">Get instant FODMAP info for any food or ingredient list based on your profile. This is not medical advice.</p>
                    
                    <div class="flex gap-2 mb-3">
                        <input type="text" id="ai-food-search-input" placeholder="e.g., 'avocado' or 'cashews'" class="w-full pl-4 pr-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition"> 
                        <button id="ai-text-search-btn" class="bg-primary text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-primary-dark transition-colors duration-300 shadow">Search</button> 
                    </div>

                    <div class="text-center my-3"><span class="text-slate-400 text-sm">OR</span></div>
                    
                    <div class="border-2 border-dashed border-slate-300 rounded-lg p-4 sm:p-6 text-center">
                        <img id="image-preview" class="hidden max-h-32 sm:max-h-40 mx-auto mb-3 rounded-md" /> 
                        <p id="upload-prompt-text" class="text-subtle mb-3">Upload a photo of an ingredient list.</p>
                        
                        <input type="file" id="image-upload-input" class="hidden" accept="image/*">
                        <input type="file" id="camera-upload-input" class="hidden" accept="image/*" capture="environment">
                        
                        <div class="flex flex-col sm:flex-row gap-2 justify-center"> 
                            <button id="upload-image-btn" class="flex-1 bg-primary text-white font-semibold py-2 px-4 rounded-lg hover:bg-primary-dark transition-colors duration-300 shadow flex items-center justify-center gap-2">
                                <i class="fas fa-images mr-2"></i> Choose from Gallery
                            </button>
                            <button id="take-photo-btn" class="flex-1 bg-primary text-white font-semibold py-2 px-4 rounded-lg hover:bg-primary-dark transition-colors duration-300 shadow flex items-center justify-center gap-2">
                                <i class="fas fa-camera mr-2"></i> Take Photo
                            </button>
                        </div>
                        <p class="text-xs text-slate-400 mt-2">Note: 'Take Photo' requires camera permissions. If it opens your gallery, your browser or this environment may not support direct camera access.</p>
                    </div>
                    
                    <div id="ai-results-loader" class="hidden flex justify-center items-center py-6"><div class="loader"></div></div> 
                    <div id="ai-results-container" class="mt-4 bg-slate-50 p-3 rounded-lg hidden"> 
                        <div id="ai-results-content" class="text-secondary leading-relaxed text-sm"></div> 
                    </div>
                </div>
            </section>

            <section id="reintroduction-log" class="page hidden">
                <div id="add-log-entry-wrapper" class="bg-white p-4 sm:p-6 rounded-xl shadow-md mb-4 max-w-3xl mx-auto"> 
                    <h2 class="text-xl sm:text-2xl font-semibold mb-3 text-secondary">✏️ Add Log Entry</h2>
                    <form id="log-form" class="space-y-3"> 
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3"> 
                            <input type="date" id="log-date" class="w-full p-2.5 border border-slate-300 rounded-lg" required> 
                             <select id="log-fodmap-group" class="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary" required> 
                                 <option value="" disabled selected>Select FODMAP Group...</option>
                             </select>
                        </div>
                        <button type="button" id="plan-challenge-btn" class="w-full bg-primary text-white font-semibold py-2 px-4 rounded-lg hover:bg-primary-dark transition-colors duration-300 shadow flex items-center justify-center gap-2">
                           ✨ Plan My Challenge
                        </button>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3"> 
                            <input type="text" id="log-food" placeholder="Food Name" class="w-full p-2.5 border border-slate-300 rounded-lg" required> 
                            <input type="text" id="log-dose" placeholder="Dose" class="w-full p-2.5 border border-slate-300 rounded-lg" required> 
                        </div>
                        
                        <select id="log-symptom" class="w-full p-2.5 border border-slate-300 rounded-lg" required> 
                            <option value="" disabled selected>Select Symptom...</option>
                            <option>None</option>
                            <option>Bloating</option>
                            <option>Gas</option>
                            <option>Abdominal pain</option>
                            <option>Diarrhea</option>
                            <option>Constipation</option>
                            <option>Fatigue</option>
                            <option>Headache</option>
                            <option value="Other">Other</option>
                        </select>
                        <input type="text" id="log-symptom-other" placeholder="Describe other symptom" class="w-full p-2.5 border border-slate-300 rounded-lg hidden"> 

                        <div id="severity-section" class="hidden pt-1"> 
                            <label class="block mb-1 text-sm font-medium text-secondary">Severity</label> 
                            <!-- This is the new button group container -->
                            <div id="log-severity" class="severity-btn-group"> 
                                <!-- Buttons will be injected by setupLogForm -->
                            </div>
                            <!-- Hidden input to store the value -->
                            <input type="hidden" id="log-severity-value" value="1">
                        </div>

                        <textarea id="log-notes" rows="2" placeholder="Additional Notes (optional)" class="w-full p-2.5 border border-slate-300 rounded-lg"></textarea> 
                        <button type="submit" class="w-full bg-primary text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-primary-dark transition-colors duration-300 shadow">Add Entry</button> 
                    </form>
                </div>
                 <div class="space-y-3 max-w-3xl mx-auto"> 
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center px-2 space-y-2 sm:space-y-0">
                        <div class="flex-shrink-0">
                             <h2 class="text-xl sm:text-2xl font-semibold text-secondary">🧾 Reintroduction Log</h2>
                             <p class="text-sm text-subtle">Tap an entry to see details.</p>
                        </div>
                         <select id="log-filter" class="w-full sm:w-auto p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-primary bg-white">
                         </select>
                    </div>
                    <div id="log-entries" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3"> 
                    </div>
                 </div>
            </section>
            
            <section id="profile" class="page hidden max-w-3xl mx-auto">
                 <div class="bg-white p-4 sm:p-6 rounded-xl shadow-md">
                    <h2 class="text-xl sm:text-2xl font-semibold mb-3 text-secondary flex items-center"><i class="fas fa-user-edit text-primary mr-2"></i>Personalize Your Profile</h2>
                    <p class="text-subtle mb-4 text-sm">Your selections here will customize the AI Assistant's advice to your specific needs.</p> 

                    <form id="profile-form" class="space-y-4">
                        <div>
                            <h3 class="font-semibold text-secondary mb-1.5">API Key</h3> 
                            <p class="text-xs text-subtle mb-1.5">Get your key from <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-primary underline">Google AI Studio</a>. This is saved only in your browser.</p>
                            <input type="password" id="profile-api-key" placeholder="Enter your Google AI API Key" class="w-full p-2 border border-slate-300 rounded-lg"> 
                        </div> 
                        <div>
                            <h3 class="font-semibold text-secondary mb-1.5">Health Conditions</h3> 
                            <div id="profile-diagnoses" class="flex flex-wrap gap-2"> 
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="font-semibold text-secondary mb-1.5">Intolerances & Allergies</h3> 
                            <div id="profile-intolerances" class="flex flex-wrap gap-2"> 
                            </div>
                            <input type="text" id="profile-allergies-other" placeholder="List other allergies (comma separated)" class="mt-2 w-full p-2 border border-slate-300 rounded-lg"> 
                        </div>
                        
                        <div>
                            <h3 class="font-semibold text-secondary mb-1.5">Dietary Preferences</h3> 
                            <div id="profile-preferences" class="flex flex-wrap gap-2"> 
                            </div>
                        </div>
                        
                        <button type="submit" class="w-full bg-primary text-white font-semibold py-2.5 px-4 rounded-lg hover:bg-primary-dark transition-colors duration-300 shadow">Save Profile</button> 
                    </form>
                </div>
            </section>
        </main>
        
        <div id="toast" class="fixed bottom-4 right-4 bg-accent text-white py-2 px-4 rounded-lg shadow-xl opacity-0 transform translate-y-10 transition-all duration-500 ease-in-out text-sm z-50"> 
            <p>Saved successfully!</p>
        </div>

        <div id="gemini-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[60] hidden"> 
            <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full">
                <div class="p-4 border-b border-slate-200 flex justify-between items-center"> 
                    <h3 id="gemini-modal-title" class="text-lg font-semibold text-secondary">AI Assistant</h3> 
                    <button id="gemini-modal-close" class="text-slate-400 hover:text-slate-600 text-2xl">&times;</button>
                </div>
                <div class="p-4 max-h-[60vh] overflow-y-auto"> 
                    <div id="gemini-modal-loader" class="flex justify-center items-center py-8"><div class="loader"></div></div> 
                    <div id="gemini-modal-content" class="text-secondary leading-relaxed hidden text-sm"></div> 
                    <div id="gemini-modal-error" class="text-error bg-red-50 p-3 rounded-lg hidden text-sm"></div> 
                </div>
                 <div class="p-3 bg-slate-50 border-t border-slate-200 text-center text-xs text-slate-500 rounded-b-xl"> 
                    Disclaimer: AI-generated responses are for informational purposes only.
                </div>
            </div>
        </div>

        <div id="info-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[60] hidden"> 
            <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full">
                <div class="p-4 border-b border-slate-200 flex justify-between items-center"> 
                    <h3 id="info-modal-title" class="text-xl font-semibold text-primary">🚀 FODMAP Journey!</h3> 
                    <button id="info-modal-close" class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
                </div>
                <div id="info-modal-content" class="p-4 max-h-[70vh] overflow-y-auto text-sm"> 
                    <h2>🔬 What are FODMAPs?</h2>
                    <p><strong>F</strong>ermentable <strong>O</strong>ligosaccharides, <strong>D</strong>isaccharides, <strong>M</strong>onosaccharides, <strong>A</strong>nd <strong>P</strong>olyols.</p>
                    <p>Short-chain carbs poorly absorbed in the small intestine. They draw water and ferment in the large intestine, causing gas, bloating, etc.</p>
                    
                    <h2 class="mt-4">🗺️ The 3 Phases</h2> 
                    <h3>Phase 1: Restriction (2-6 Weeks)</h3>
                    <p>🚫 Remove high-FODMAP foods to calm symptoms.</p>
                    <h3>Phase 2: Reintroduction</h3>
                    <p>🧪 Systematically reintroduce groups to identify triggers (use the Reintro Log!).</p>
                    <h3>Phase 3: Personalization</h3>
                    <p>🧘 Build a long-term diet including tolerated foods.</p>

                    <h2 class="mt-4">👥 Meet the Groups</h2> 
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-2"> 
                        <div class="fodmap-group-card border-l-yellow-400">
                            <h3 class="text-yellow-700 !mt-0">🍎 Fructose</h3>
                            <p>Honey, Apples, Mango, Agave, HFCS</p>
                        </div>
                        <div class="fodmap-group-card border-l-blue-400">
                            <h3 class="text-blue-700 !mt-0">🥛 Lactose</h3>
                            <p>Milk, Yogurt, Soft Cheeses, Ice Cream</p>
                        </div>
                        <div class="fodmap-group-card border-l-orange-400">
                        <h3 class="text-orange-700 !mt-0">🍞 Fructans - Grains</h3>
                        <p>Wheat, Rye, Barley</p>
                        </div>
                        <div class="fodmap-group-card border-l-purple-400">
                            <h3 class="text-purple-700 !mt-0">🧅 Fructans - Veg & Fruit</h3>
                            <p>Onion, Garlic, Leek, Inulin</p>
                        </div>
                        <div class="fodmap-group-card border-l-teal-400">
                            <h3 class="text-teal-700 !mt-0">🫘 GOS</h3>
                            <p>Beans, Lentils, Chickpeas, Cashews</p>
                        </div>
                        <div class="fodmap-group-card border-l-green-400">
                            <h3 class="text-green-700 !mt-0">🥑 Sorbitol</h3>
                            <p>Avocado, Blackberries, Peaches, Gum</p>
                        </div>
                        <div class="fodmap-group-card border-l-indigo-400">
                            <h3 class="text-indigo-700 !mt-0">🍄 Mannitol</h3>
                            <p>Mushrooms, Cauliflower, Sweet Potato</p>
                        </div>
                    </div>
                    <div class="info-note mt-4 p-3 rounded-lg text-center"> 
                        <h3 class="!mt-0 text-secondary">👩‍⚕️ Quick Note!</h3>
                        <p>Work with a dietitian! This app supports, not replaces, professional advice.</p>
                    </div>
                </div>
                 <div class="p-3 bg-slate-50 border-t border-slate-200 text-right rounded-b-xl"> 
                    <button id="info-modal-close-btn" class="bg-primary text-white font-semibold py-1.5 px-4 rounded-lg hover:bg-primary-dark transition-colors text-sm">Got it!</button> 
                </div>
            </div>
        </div>

        <div id="side-menu-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden"_></div>
        <div id="side-menu-modal" class="fixed top-0 left-0 h-full w-64 bg-white shadow-2xl z-40 hidden p-4"> 
            <div class="flex justify-between items-center mb-4"> 
                <h2 class="text-xl font-bold text-primary">Menu</h2> 
                <button id="side-menu-close" class="text-slate-400 hover:text-slate-600 text-3xl">&times;</button>
            </div>
            <nav>
                <ul>
                    <li>
                        <button id="open-info-modal-btn" class="w-full text-left py-2.5 px-3 rounded-lg hover:bg-slate-100 text-secondary font-medium text-sm"> 
                            <i class="fas fa-book-open w-5 mr-2 text-primary"></i>Understand FODMAPS
                        </button>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
    
    <button id="add-entry-fab" class="hidden fixed bottom-4 right-4 bg-primary text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center text-xl hover:bg-primary-dark transition-transform hover:scale-110 z-50"> 
        <i class="fas fa-plus"></i>
    </button>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

             const FODMAP_GROUP_DATA = [ { value: "Fructose", name: "Fructose", examples: "(e.g., Honey, Mango)" }, { value: "Lactose", name: "Lactose", examples: "(e.g., Milk, Yogurt)" }, { value: "Fructans (Grains)", name: "Fructans - Grains", examples: "(e.g., Wheat, Rye)" }, { value: "Fructans (Veg & Fruit)", name: "Fructans - Veg & Fruit", examples: "(e.g., Onion, Garlic)" }, { value: "GOS", name: "Galactans (GOS)", examples: "(e.g., Beans, Lentils)" }, { value: "Polyols (Sorbitol)", name: "Polyols - Sorbitol", examples: "(e.g., Avocado, Blackberry)" }, { value: "Polyols (Mannitol)", name: "Polyols - Mannitol", examples: "(e.g., Cauliflower, Mushroom)" } ];
             const SEVERITY_LEVELS = { 1: '😄', 2: '🙂', 3: '😐', 4: '😣', 5: '😫' };
             const FODMAP_STYLES = { "Fructose": { color: "bg-yellow-100 text-yellow-800", icon: "🍎" }, "Lactose": { color: "bg-blue-100 text-blue-800", icon: "🥛" }, "Fructans (Grains)": { color: "bg-orange-100 text-orange-800", icon: "🍞" }, "Fructans (Veg & Fruit)": { color: "bg-purple-100 text-purple-800", icon: "🧅" }, "GOS": { color: "bg-teal-100 text-teal-800", icon: "🫘" }, "Polyols (Sorbitol)": { color: "bg-green-100 text-green-800", icon: "🥑" }, "Polyols (Mannitol)": { color: "bg-indigo-100 text-indigo-800", icon: "🍄" } };
             const PROFILE_OPTIONS = { diagnoses: ["IMO", "SIBO", "IBS-D", "IBS-C", "IBS-M"], intolerances: ["Sorbitol", "Mannitol", "Lactose", "Fructose", "Gluten"], preferences: ["Vegetarian", "Vegan", "Pescatarian"] };

            const pages = document.querySelectorAll('.page');
            const navItems = document.querySelectorAll('.nav-item');
            const addEntryFab = document.getElementById('add-entry-fab');
            let logEntries = JSON.parse(localStorage.getItem('fodmapLogEntries')) || [];
            let userProfile = JSON.parse(localStorage.getItem('fodmapUserProfile')) || { diagnoses: [], intolerances: [], allergiesOther: '', preferences: [], apiKey: '' };            let currentFilter = 'All';
            let currentPageIndex = 0;

            function navigateTo(pageId) {
                const targetPage = document.getElementById(pageId);
                if (!targetPage) return;

                pages.forEach(page => page.classList.add('hidden'));
                targetPage.classList.remove('hidden');
                
                navItems.forEach((item, index) => {
                    const isActive = item.dataset.page === pageId;
                    item.classList.toggle('active', isActive);
                    if (isActive) {
                        currentPageIndex = index;
                    }
                });
                
                addEntryFab.classList.toggle('hidden', pageId === 'reintroduction-log');
                window.scrollTo(0, 0);
                 document.querySelectorAll('.nav-item span').forEach(span => { span.classList.remove('hidden', 'sm:inline'); span.classList.add('hidden', 'sm:inline'); });
            }

            function goToNextTab() {
                const nextIndex = (currentPageIndex + 1) % navItems.length;
                const nextPageId = navItems[nextIndex].dataset.page;
                navigateTo(nextPageId);
            }

            function goToPrevTab() {
                const prevIndex = (currentPageIndex - 1 + navItems.length) % navItems.length;
                const prevPageId = navItems[prevIndex].dataset.page;
                navigateTo(prevPageId);
            }

            navItems.forEach(item => item.addEventListener('click', () => navigateTo(item.dataset.page)));
            addEntryFab.addEventListener('click', () => { navigateTo('reintroduction-log'); document.getElementById('add-log-entry-wrapper').scrollIntoView({ behavior: 'smooth' }); });
            
            const toast = document.getElementById('toast');
            function showToast(message = "Saved!", isError = false) {
                toast.textContent = message;
                toast.className = `fixed bottom-4 right-4 text-white py-2 px-4 rounded-lg shadow-xl opacity-0 transform translate-y-10 transition-all duration-500 ease-in-out text-sm z-50 ${isError ? 'bg-error' : 'bg-accent'}`; 
                toast.classList.remove('opacity-0', 'translate-y-10');
                setTimeout(() => toast.classList.add('opacity-0', 'translate-y-10'), 3000);
            }

            const aiFoodSearchInput = document.getElementById('ai-food-search-input');
            const aiTextSearchBtn = document.getElementById('ai-text-search-btn');
            const uploadImageBtn = document.getElementById('upload-image-btn');
            const imageUploadInput = document.getElementById('image-upload-input');
            const takePhotoBtn = document.getElementById('take-photo-btn');
            const cameraUploadInput = document.getElementById('camera-upload-input');
            const imagePreview = document.getElementById('image-preview');
            const uploadPromptText = document.getElementById('upload-prompt-text');
            const aiResultsLoader = document.getElementById('ai-results-loader');
            const aiResultsContainer = document.getElementById('ai-results-container');
            const aiResultsContent = document.getElementById('ai-results-content');
            
            const buildProfileContext = () => {
                let context = "User profile:"; let hasInfo = false;
                if (userProfile.diagnoses.length > 0) { context += ` Diagnoses: ${userProfile.diagnoses.join(', ')}.`; hasInfo = true; }
                const allIntolerances = [...userProfile.intolerances, userProfile.allergiesOther].filter(Boolean);
                if (allIntolerances.length > 0) { context += ` Intolerances/Allergies: ${allIntolerances.join(', ')}.`; hasInfo = true; }
                if (userProfile.preferences.length > 0) { context += ` Preferences: ${userProfile.preferences.join(', ')}.`; hasInfo = true; }
                return hasInfo ? context : "User profile not specified.";
            };

            const getProfileForDisplay = () => {
                let displayLines = [];
                if (userProfile.diagnoses.length > 0) { displayLines.push(`<strong>Diagnoses:</strong> ${userProfile.diagnoses.join(', ')}`); }
                const allIntolerances = [...userProfile.intolerances, userProfile.allergiesOther].filter(Boolean);
                if (allIntolerances.length > 0) { displayLines.push(`<strong>Intolerances/Allergies:</strong> ${allIntolerances.join(', ')}`); }
                if (userProfile.preferences.length > 0) { displayLines.push(`<strong>Preferences:</strong> ${userProfile.preferences.join(', ')}`); }
                
                if (displayLines.length === 0) return null;
                return displayLines.join('<br>');
            };

            const handleAIQuery = (prompt, title, imageData = null) => {
                 aiResultsLoader.classList.remove('hidden'); aiResultsContainer.classList.add('hidden'); aiResultsContent.innerHTML = '';
                 callGeminiAPI(prompt, imageData)
                    .then(response => {
                        if (response) { 
                            const profileHTML = getProfileForDisplay();
                            const disclaimer = `Disclaimer: I am a FODMAP expert analysis tool, not a medical professional. This information is for educational purposes regarding dietary management only and is not a substitute for personalized medical advice or treatment. Always consult with your doctor or a registered dietitian before making dietary changes.`;

                            // 1. Process the AI response
                            let aiContent = response
                                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')   // Bold
                                .replace(/\*(.*?)\*/g, '<em>$1</em>')     // Italics
                                .replace(/\n/g, '<br>'); // Newlines

                            // 2. Build the full response with header and footer
                            let html = `
                                <div class="space-y-3">
                                    <div>
                                        <p><strong>Food:</strong> ${title}</p>
                                        ${profileHTML ? `<p>${profileHTML}</p>` : ''}
                                    </div>
                                    
                                    <hr class="border-slate-200">
                                    
                                    <div>${aiContent}</div>

                                    <hr class="border-slate-200">
                                    
                                    <p class="text-xs text-subtle italic">${disclaimer}</p>
                                </div>
                            `;
                            
                            aiResultsContent.innerHTML = html; 
                            aiResultsContainer.classList.remove('hidden'); 
                        }                    
                        else { aiResultsContent.innerHTML = `<p class="text-error">Sorry, error.</p>`; aiResultsContainer.classList.remove('hidden'); }
                    }).finally(() => aiResultsLoader.classList.add('hidden'));
            };

            aiTextSearchBtn.addEventListener('click', () => {
                const foodName = aiFoodSearchInput.value.trim(); if (!foodName) { showToast("Enter food.", true); return; }
                const prompt = `FODMAP expert: Analyze '${foodName}'. ${buildProfileContext()}
                Provide a concise, 3-part answer. 
                Use this exact template:
                **FODMAP Level:** [Brief level & why. Use *italics* or emojis for emphasis, not full bold sentences.]
                **Safe Portion:** [Brief portion size. Use *italics* or emojis for emphasis.]
                **Substitutes:** [List 3-4 substitutes. Use *italics* or emojis for emphasis.]

                Do NOT use tables, '###', '---', or '|'. Omit the disclaimer.`;
                handleAIQuery(prompt, foodName);
            });

            const handleFileSelect = (event) => {
                const file = event.target.files[0]; if (!file) return; const reader = new FileReader();
                reader.onload = (e) => {
                    const base64 = e.target.result.split(',')[1]; imagePreview.src = e.target.result; imagePreview.classList.remove('hidden'); uploadPromptText.textContent = file.name;
                    const prompt = `FODMAP expert: Analyze ingredients in this image. ${buildProfileContext()}
                    List all ingredients found. 
                    For any high-FODMAP ingredient, explain why in one short sentence. Use *italics* or emojis for emphasis.
                    Provide an **Overall Summary:** (Safe or Not Safe).
                    Format *only* with **bold** headings, *italics*, newlines, and emojis. 
                    Do NOT use tables, '###', '---', or '|'. Omit the disclaimer.`;
                    handleAIQuery(prompt, `Image (${file.name})`, base64);
                }; reader.readAsDataURL(file); event.target.value = null; 
            };
            
            uploadImageBtn.addEventListener('click', () => imageUploadInput.click());
            takePhotoBtn.addEventListener('click', () => cameraUploadInput.click());
            imageUploadInput.addEventListener('change', handleFileSelect);
            cameraUploadInput.addEventListener('change', handleFileSelect);

            const summaryContainer = document.getElementById('progress-summary');
            const renderHomePage = () => {
                summaryContainer.innerHTML = '';
                FODMAP_GROUP_DATA.forEach(groupData => {
                    const entries = logEntries.filter(entry => entry.group === groupData.value); const count = entries.length;
                    let statusText, icon, color;
                    if (count === 0) { statusText = "Not Started"; icon = "fa-times-circle"; color = "text-subtle"; } 
                    else if (count >= 3) { statusText = `Completed (${count})`; icon = "fa-check-circle"; color = "text-accent"; } 
                    else { statusText = `In Progress (${count})`; icon = "fa-spinner fa-spin"; color = "text-warning"; }
                    const style = FODMAP_STYLES[groupData.value] || { icon: '❓' };
                    const item = document.createElement('div'); item.className = 'progress-item bg-slate-100 rounded-lg transition-colors duration-300'; item.dataset.group = groupData.value;
                    item.innerHTML = `<div class="progress-item-header flex items-center justify-between p-3 cursor-pointer hover:bg-slate-200 rounded-lg"><div class="flex items-center gap-2"><i class="fas fa-chevron-right expand-icon text-slate-400 transition-transform duration-300 text-xs"></i><div><p class="font-semibold text-secondary text-sm"><span class="mr-1">${style.icon}</span>${groupData.name}</p><p class="text-xs text-subtle">${groupData.examples.slice(1, -1)}</p></div></div><div class="flex items-center gap-1.5 ${color}"><i class="fas ${icon} text-xs"></i><span class="text-xs font-medium">${statusText}</span></div></div><div class="progress-item-body border-t border-slate-200">${ entries.length > 0 ? entries.sort((a,b) => new Date(b.date) - new Date(a.date)).map(e => { const sym = e.symptom === 'Other' ? e.otherSymptom : e.symptom; const sevE = SEVERITY_LEVELS[e.severity] || ''; const sevT = e.symptom !== 'None' && e.symptom !== '' ? `${sevE} ${e.severity}/5` : 'No Symptoms'; return `<p><strong>${new Date(e.date).toLocaleDateString('en-CA')}:</strong> ${e.food} (${e.dose}) - <em>${sym} ${sevT}</em></p>`}).join('') : '<p class="text-subtle italic p-3 text-xs">No entries.</p>' }</div>`;
                    summaryContainer.appendChild(item);
                });
            };
            summaryContainer.addEventListener('click', (e) => {
                const header = e.target.closest('.progress-item-header'); if (header) { const item = header.parentElement; const expanded = item.classList.contains('expanded'); summaryContainer.querySelectorAll('.progress-item').forEach(i => i.classList.remove('expanded')); if (!expanded) item.classList.add('expanded'); }
            });

            const logForm = document.getElementById('log-form');
            const logEntriesContainer = document.getElementById('log-entries');
            const logFilter = document.getElementById('log-filter');
            const symptomSelector = document.getElementById('log-symptom');
            const otherSymptomInput = document.getElementById('log-symptom-other');

            const setupLogForm = () => {
                const groupSel = document.getElementById('log-fodmap-group'); if (groupSel.options.length <= 1) FODMAP_GROUP_DATA.forEach(g => groupSel.innerHTML += `<option value="${g.value}">${g.name} ${g.examples}</option>`);
                const sevCont = document.getElementById('log-severity'); 
                const sevSect = document.getElementById('severity-section'); 
                const sevInput = document.getElementById('log-severity-value');
                sevCont.innerHTML = ''; // Clear container

                // Create the 5 buttons
                for (let i = 1; i <= 5; i++) {
                    const btn = document.createElement('button');
                    btn.type = 'button'; // Prevent form submission
                    btn.className = 'severity-btn';
                    btn.textContent = i;
                    btn.dataset.value = i;
                    if (i === 1) {
                        btn.classList.add('selected'); // Select '1' by default
                    }
                    sevCont.appendChild(btn);
                }

                // Add event listener to the group
                    sevCont.addEventListener('click', (e) => {
                        const clickedButton = e.target.closest('.severity-btn');
                        if (clickedButton) {
                            // Remove 'selected' from all buttons
                            sevCont.querySelectorAll('.severity-btn').forEach(btn => btn.classList.remove('selected'));
                            // Add 'selected' to the clicked button
                            clickedButton.classList.add('selected');
                            // Update the hidden input
                            sevInput.value = clickedButton.dataset.value;
                        }
                    });
                                    symptomSelector.addEventListener('change', () => { const val = symptomSelector.value; otherSymptomInput.classList.toggle('hidden', val !== 'Other'); sevSect.classList.toggle('hidden', val === '' || val === 'None'); });
                };
            
            const populateFilter = () => { logFilter.innerHTML = `<option value=All>All Groups</option>`; FODMAP_GROUP_DATA.forEach(g => logFilter.innerHTML += `<option value="${g.value}">${g.name}</option>`); };
            logFilter.addEventListener('change', (e) => { currentFilter = e.target.value; renderLogEntries(); });

            const renderLogEntries = () => {
                logEntriesContainer.innerHTML = ''; const filtered = logEntries.filter(e => currentFilter === 'All' || e.group === currentFilter);
                if (filtered.length === 0) { logEntriesContainer.innerHTML = `<p class="text-subtle text-center py-6 bg-white rounded-lg shadow-sm col-span-full text-sm">No logs.</p>`; return; }
                filtered.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach((entry) => {
                    const idx = logEntries.findIndex(i => i.id === entry.id); const div = document.createElement('div'); div.className = 'log-item bg-white rounded-lg shadow-sm border border-slate-200 duration-300';
                    const style = FODMAP_STYLES[entry.group] || { color: 'bg-slate-100', icon: '❓' }; const info = FODMAP_GROUP_DATA.find(g => g.value === entry.group); const name = info ? info.name : entry.group;
                    const sym = entry.symptom === 'Other' ? entry.otherSymptom : entry.symptom; const sevE = SEVERITY_LEVELS[entry.severity] || ''; const sevT = entry.symptom !== 'None' && entry.symptom !== '' ? `${sevE} ${entry.severity}/5` : 'No Symptoms';
                    div.innerHTML = `<div class="log-item-header p-3 cursor-pointer"><div class="flex justify-between items-start mb-1"><div class="flex items-center gap-2"><i class="fas fa-chevron-right expand-icon text-slate-400 duration-300 text-xs"></i><div><p class="font-bold text-secondary text-sm">${entry.food}</p><p class="text-xs text-subtle">${new Date(entry.date).toLocaleDateString('en-CA')}</p></div></div><span class="text-xs font-semibold px-1.5 py-0.5 rounded-full ${style.color}">${style.icon} ${name.split(' ')[0]}</span></div><div class="flex justify-end items-end"><span class="text-xs font-semibold text-right">${sym} ${sevT}</span></div></div><div class="log-item-body border-t border-slate-100"><div class="space-y-1.5 text-xs text-muted"><p><strong>Dose:</strong> ${entry.dose}</p>${entry.symptom === 'Other' ? `<p><strong>Detail:</strong> ${entry.otherSymptom}</p>` : ''}${entry.notes ? `<p><strong>Notes:</strong> ${entry.notes}</p>` : ''}<div class="pt-1.5 text-right"><button class="delete-entry-btn text-error hover:text-error-dark font-semibold py-0.5 px-1.5 rounded text-xs" data-index=${idx}><i class="fas fa-trash-alt mr-1"></i>Del</button></div></div></div>`;
                    logEntriesContainer.appendChild(div);
                });
            };
            
            logEntriesContainer.addEventListener('click', (e) => {
                const header = e.target.closest('.log-item-header'); if (header) { header.parentElement.classList.toggle('expanded'); return; }
                const delBtn = e.target.closest('.delete-entry-btn'); if(delBtn) { logEntries.splice(parseInt(delBtn.dataset.index), 1); saveLogEntries(); showToast("Deleted."); }
            });

            const saveLogEntries = () => { localStorage.setItem('fodmapLogEntries', JSON.stringify(logEntries)); renderLogEntries(); renderHomePage(); };

            logForm.addEventListener('submit', (e) => {
            e.preventDefault(); const sev = document.getElementById('log-severity-value'); const symVal = symptomSelector.value;
                const entry = { id: Date.now(), date: document.getElementById('log-date').value, group: document.getElementById('log-fodmap-group').value, food: document.getElementById('log-food').value, dose: document.getElementById('log-dose').value, symptom: symVal, otherSymptom: symVal === 'Other' ? otherSymptomInput.value : '', severity: (symVal !== 'None' && symVal !== '') ? sev.value : '1', notes: document.getElementById('log-notes').value };
                logEntries.push(entry); saveLogEntries(); logForm.reset(); document.getElementById('log-date').valueAsDate = new Date(); otherSymptomInput.classList.add('hidden'); document.getElementById('severity-section').classList.add('hidden'); 
                
                // Reset severity button group
                document.getElementById('log-severity-value').value = '1';
                document.querySelectorAll('#log-severity .severity-btn').forEach(btn => {
                    btn.classList.toggle('selected', btn.dataset.value === '1');
                });
                
                showToast("Added!");
            });

            const profileForm = document.getElementById('profile-form');
            const createCheckbox = (id, val, name, checked) => `<div class=inline-block><input type=checkbox id=${id} value="${val}" name=${name} class="profile-checkbox hidden" ${checked?'checked':''}><label for=${id} class="cursor-pointer border border-slate-300 rounded-lg px-2.5 py-1.5 text-xs font-medium text-muted duration-200">${val}</label></div>`;

            const setupProfilePage = () => {
                document.getElementById('profile-diagnoses').innerHTML = PROFILE_OPTIONS.diagnoses.map(i => createCheckbox(`diag-${i}`, i, 'diagnoses', userProfile.diagnoses.includes(i))).join('');
                document.getElementById('profile-intolerances').innerHTML = PROFILE_OPTIONS.intolerances.map(i => createCheckbox(`intol-${i}`, i, 'intolerances', userProfile.intolerances.includes(i))).join('');
                document.getElementById('profile-preferences').innerHTML = PROFILE_OPTIONS.preferences.map(i => createCheckbox(`pref-${i}`, i, 'preferences', userProfile.preferences.includes(i))).join('');
                document.getElementById('profile-allergies-other').value = userProfile.allergiesOther || '';
                document.getElementById('profile-api-key').value = userProfile.apiKey || '';
            };

            profileForm.addEventListener('submit', (e) => {
                e.preventDefault(); userProfile.diagnoses = Array.from(document.querySelectorAll('input[name=diagnoses]:checked')).map(el => el.value); userProfile.intolerances = Array.from(document.querySelectorAll('input[name=intolerances]:checked')).map(el => el.value); userProfile.preferences = Array.from(document.querySelectorAll('input[name=preferences]:checked')).map(el => el.value); userProfile.allergiesOther = document.getElementById('profile-allergies-other').value.trim();
                userProfile.apiKey = document.getElementById('profile-api-key').value.trim();
                localStorage.setItem('fodmapUserProfile', JSON.stringify(userProfile)); showToast("Profile Saved!");
            });

            const hamBtn = document.getElementById('hamburger-btn'); const sideMdl = document.getElementById('side-menu-modal'); const sideOvl = document.getElementById('side-menu-overlay'); const sideClose = document.getElementById('side-menu-close'); const openInfoBtn = document.getElementById('open-info-modal-btn'); const infoMdl = document.getElementById('info-modal'); const infoClose = document.getElementById('info-modal-close'); const infoCloseBtn = document.getElementById('info-modal-close-btn');
            const openSide = () => { sideMdl.classList.remove('hidden'); sideOvl.classList.remove('hidden'); }; const closeSide = () => { sideMdl.classList.add('hidden'); sideOvl.classList.add('hidden'); }; const openInfo = () => { infoMdl.classList.remove('hidden'); }; const closeInfo = () => { infoMdl.classList.add('hidden'); };
            hamBtn.addEventListener('click', openSide); sideClose.addEventListener('click', closeSide); sideOvl.addEventListener('click', closeSide); openInfoBtn.addEventListener('click', () => { closeSide(); openInfo(); }); infoClose.addEventListener('click', closeInfo); infoCloseBtn.addEventListener('click', closeInfo);

            const geminiMdl = document.getElementById('gemini-modal'); const geminiTitle = document.getElementById('gemini-modal-title'); const geminiContent = document.getElementById('gemini-modal-content'); const geminiLoader = document.getElementById('gemini-modal-loader'); const geminiError = document.getElementById('gemini-modal-error'); const geminiClose = document.getElementById('gemini-modal-close');
            const openGemini = (title) => { geminiTitle.textContent = title; geminiMdl.classList.remove('hidden'); geminiLoader.classList.remove('hidden'); geminiContent.classList.add('hidden'); geminiError.classList.add('hidden'); }; const closeGemini = () => geminiMdl.classList.add('hidden'); geminiClose.addEventListener('click', closeGemini);
            const callGeminiAPI = async (prompt, imgData = null, retries = 3, delay = 1000) => {
                const key = userProfile.apiKey || ""; 
                if (!key) {
                    console.error("API Key is missing. Please add it in the Profile tab.");
                    showToast("API Key is missing. Add it in your Profile.", true);
                    return null; // Stop the API call
                }
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`; let parts = [{ text: prompt }]; if (imgData) parts.push({ inlineData: { mimeType: 'image/jpeg', data: imgData } }); const payload = { contents: [{ parts }] };
                try {
                    const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!res.ok) { if (res.status === 429 && retries > 0) { await new Promise(r => setTimeout(r, delay)); return callGeminiAPI(prompt, imgData, retries - 1, delay * 2); } throw new Error(`${res.statusText} (${res.status})`); }
                    const result = await res.json(); return result.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (err) { console.error("API failed:", err); return null; }
            };
            document.getElementById('summarize-journey-btn').addEventListener('click', async () => {
                if (logEntries.length === 0) { showToast("Need logs.", true); return; } 
                openGemini('✨ Summary'); 
                const logTxt = logEntries.map(e => `Date:${e.date},Grp:${e.group},Food:${e.food},Dose:${e.dose},Sym:${e.symptom==='Other'?e.otherSymptom:e.symptom},Sev:${e.severity}/5`).join('; '); 
                
                // 1. UPDATED PROMPT:
                const prompt = `FODMAP helper (no medical advice). Analyze log based on profile: ${buildProfileContext()}. Log: ${logTxt}
        
                Provide a gentle, 3-part summary based *only* on the log entries and user profile.
                Format *only* with **bold** headings, *italics* for emphasis, and newlines. Use bullet points (like - or *) for lists.
                Do NOT use '###', '|', or tables. Omit the disclaimer.

                Use this exact template:
                **Overall Observation:** [A 1-2 sentence gentle observation about any potential patterns.]
                **Potential Triggers:** [A bulleted list of foods/groups from the log that *consistently* show symptoms with a severity of 3-5. If none, say "No clear triggers noted yet."]
                **Seemingly Well-Tolerated:** [A bulleted list of foods/groups from the log that *consistently* show "None" or low severity (1-2). If none, say "Keep logging to find your safe foods."]`

                                const summary = await callGeminiAPI(prompt); 
                                geminiLoader.classList.add('hidden'); 
                                if (summary === null && !userProfile.apiKey) { geminiMdl.classList.add('hidden'); return; } 
                                
                                // 2. FIXED PARSER:
                                if (summary) { 
                                    // Add the same parser we use for the AI assistant
                                    let html = summary
                                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')   // Bold
                                        .replace(/\*(.*?)\*/g, '<em>$1</em>')     // Italics
                                        .replace(/(\n|^)[\-\*] (.*?)(?=\n|$)/g, '<br>• $2') // Bullets
                                        .replace(/\n/g, '<br>'); // Newlines
                                    geminiContent.innerHTML = html; // Use .innerHTML, not .textContent
                                    geminiContent.classList.remove('hidden'); 
                                } else { 
                                    geminiError.textContent = 'Summary failed.'; 
                                    geminiError.classList.remove('hidden'); 
                                }
                            });
            document.getElementById('plan-challenge-btn').addEventListener('click', async () => {
                const sel = document.getElementById('log-fodmap-group'); 
                const val = sel.value; // This gets the clean value, e.g., "Fructose"
                if (!val) { showToast("Select group.", true); return; } 
                
                // 1. Use `val` for the modal title, not the full text
                openGemini(`✨ ${val} Plan`); 

                // 2. Use `val` in the prompt for a cleaner request
                const prompt = `FODMAP helper (no medical advice). User profile: ${buildProfileContext()}.
Create a 3-day reintroduction challenge plan for '${val}'.
Give a couple of specific foods and an increasing portion for each day.
Briefly explain *why* these foods are good choices (e.g., "contains only this FODMAP").
Include a "Washout Day" instruction after Day 3.
Format *only* with **bold** headings, *italics* for emphasis, and newlines. Use bullet points (- or *).
Do NOT use '###', '|', or tables. Omit the disclaimer.

Use this exact template:
**Foods:** [Food Names]
*Why this foods?:* [Brief explanation]

**Challenge Plan:**
- **Day 1:** [Portion]
- **Day 2:** [Larger Portion]
- **Day 3:** [Largest Portion]

**After Day 3:** Wait 2-3 "washout" days and log any delayed symptoms before starting your next challenge.`;

                const plan = await callGeminiAPI(prompt); 
                geminiLoader.classList.add('hidden'); 
                if (plan === null && !userProfile.apiKey) { geminiMdl.classList.add('hidden'); return; } 
                
                // 3. Use the full parser to render HTML
                if (plan) { 
                    let html = plan
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')   // Bold
                        .replace(/\*(.*?)\*/g, '<em>$1</em>')     // Italics
                        .replace(/(\n|^)[\-\*] (.*?)(?=\n|$)/g, '<br>• $2') // Bullets
                        .replace(/\n/g, '<br>'); // This line is now correct
                    geminiContent.innerHTML = html; // Use .innerHTML
                    geminiContent.classList.remove('hidden'); 
                } else { 
                    geminiError.textContent = 'Plan failed.'; 
                    geminiError.classList.remove('hidden'); 
                }
            });

            // Dynamically set nav top and body padding
            const calculatePadding = () => { 
                const h = document.querySelector('header'); 
                const n = document.getElementById('main-nav'); 
                if (h && n) { 
                    const headerHeight = h.offsetHeight;
                    const navHeight = n.offsetHeight;
                    n.style.top = `${headerHeight}px`; // Stick nav to header
                    document.body.style.paddingTop = `${headerHeight + navHeight}px`; // Set body padding
                } 
            };
            navigateTo('home'); setupLogForm(); populateFilter(); renderLogEntries(); renderHomePage(); setupProfilePage(); document.getElementById('log-date').valueAsDate = new Date(); calculatePadding(); window.addEventListener('resize', calculatePadding);

            // --- Swipe Navigation ---
            const mainContent = document.getElementById('content');
            let touchStartX = 0;
            let touchEndX = 0;
            let touchStartY = 0;
            let touchEndY = 0;

            mainContent.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
                touchStartY = e.changedTouches[0].screenY;
            }, { passive: true });

            mainContent.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                touchEndY = e.changedTouches[0].screenY;
                handleSwipe();
            }, { passive: true });

            function handleSwipe() {
                const deltaX = touchEndX - touchStartX;
                const deltaY = touchEndY - touchStartY;
                const minSwipeDistance = 50; // Minimum pixels for a swipe

                // Check for horizontal swipe and ignore vertical scrolls
                if (Math.abs(deltaX) > minSwipeDistance && Math.abs(deltaY) < minSwipeDistance) {
                    if (deltaX > 0) {
                        // Swipe Right (Go to Previous Tab)
                        goToPrevTab();
                    } else {
                        // Swipe Left (Go to Next Tab)
                        goToNextTab();
                    }
                }
            }
        });
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful');
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>
</body>
</html>